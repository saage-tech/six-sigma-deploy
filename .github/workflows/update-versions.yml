name: Update Multiple Versions

on:
  workflow_dispatch:
    inputs:
      version_publicmq_rust:
        description: "publicmq-rust version (blank = no change)"
        required: false
        default: ""

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Update versions.json using dynamic input detection
        run: |
          file="versions.json"

          # Extract all workflow inputs as JSON
          inputs_json='${{ toJson(github.event.inputs) }}'

          echo "Inputs received:"
          echo "$inputs_json" | jq .

          # Loop through all inputs with prefix "version_"
          for input in $(echo "$inputs_json" | jq -r 'keys[] | select(startswith("version_"))'); do
            value=$(echo "$inputs_json" | jq -r --arg i "$input" '.[$i]')

            # Skip blank inputs (blank = no change)
            if [ -z "$value" ] || [ "$value" = "null" ]; then
              echo "Skipping $input (blank)"
              continue
            fi

            # Derive component name:
            # version_publicmq_rust â†’ publicmq_rust
            # Optional: convert underscores to hyphens
            comp="${input#version_}"
            comp="${comp//_/-}"

            echo "Updating component '$comp' to version '$value'"

            jq --arg c "$comp" --arg v "$value" \
              '.components[$c].ref = $v' "$file" > tmp && mv tmp "$file"
          done

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add versions.json
          git commit -m "Batch update component versions"
          git push
