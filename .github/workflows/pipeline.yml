name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - versions.json
      - .github/workflows/pipeline.yml
  workflow_dispatch:
    inputs:
      release_type:
        description: "Override release type for this run (blank = keep file)"
        required: false
        default: pre-release
        type: choice
        options:
          - pre-release
          - release
      image_publicmq_rust_ref:
        description: "publicmq-rust ref"
        required: false
        default: ""

jobs:
  prepare_metadata:
    name: Prepare release metadata
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_type: ${{ steps.extract.outputs.release_type }}
      images: ${{ steps.extract.outputs.images }}
    steps:
      - uses: actions/checkout@v4

      - name: Apply manual inputs
        if: github.event_name == 'workflow_dispatch'
        env:
          RELEASE_TYPE_INPUT: ${{ github.event.inputs.release_type }}
          INPUTS_JSON: ${{ toJson(github.event.inputs) }}
        run: |
          set -euo pipefail
          file="versions.json"
          updated="false"

          if [ -n "${RELEASE_TYPE_INPUT}" ]; then
            jq --arg rt "${RELEASE_TYPE_INPUT}" '.release_type = $rt' "$file" > tmp && mv tmp "$file"
            updated="true"
          fi

          if [ -n "${INPUTS_JSON}" ] && [ "${INPUTS_JSON}" != "null" ]; then
            for input in $(echo "${INPUTS_JSON}" | jq -r 'keys[] | select(startswith("image_"))'); do
              value=$(echo "${INPUTS_JSON}" | jq -r --arg i "$input" '.[$i]')
              if [ -z "$value" ] || [ "$value" = "null" ]; then
                echo "Skipping $input (blank)"
                continue
              fi

              image="${input#image_}"
              image="${image%_ref}"
              image="${image//_/-}"

              echo "Updating image '$image' to ref '$value'"
              jq --arg img "$image" --arg ref "$value" '.images[$img].ref = $ref' "$file" > tmp && mv tmp "$file"
              updated="true"
            done
          fi

          if [ "$updated" = "true" ]; then
            echo "versions.json updated from manual inputs."
          else
            echo "No manual overrides supplied."
          fi

      - name: Commit manual overrides
        if: github.event_name == 'workflow_dispatch'
        run: |
          set -euo pipefail
          if git diff --quiet --exit-code versions.json; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add versions.json
          git commit -m "chore: apply manual version overrides"
          git push

      - name: Extract release type
        id: extract
        run: |
          release_type=$(jq -r '.release_type // "release"' versions.json)
          images=$(jq -c '.images | to_entries | map({image: .key} + .value) // []' versions.json)
          echo "release_type=$release_type" >> "$GITHUB_OUTPUT"
          echo "images=$images" >> "$GITHUB_OUTPUT"
          echo "Release type detected: $release_type"

  push:
    name: Build and publish images
    needs: prepare_metadata
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.prepare_metadata.outputs.images) }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - name: Dispatch component workflow
        env:
          OWNER: ${{ github.repository_owner }}
          IMAGE_REPO: ${{ matrix.image.repo }}
          WORKFLOW_PATH: ${{ matrix.image.workflow }}
          IMAGE_REF: ${{ matrix.image.ref }}
          IMAGE_NAME: ${{ matrix.image.image }}
          TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          workflow_file=$(basename "$WORKFLOW_PATH")
          dispatch_url="https://api.github.com/repos/${OWNER}/${IMAGE_REPO}/actions/workflows/${workflow_file}/dispatches"
          echo "Dispatching ${OWNER}/${IMAGE_REPO}@${IMAGE_REF} workflow ${workflow_file} (image ${IMAGE_NAME})"
          curl -sSf -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${dispatch_url}" \
            -d "$(jq -n --arg ref "${IMAGE_REF}" '{ref: $ref}')"
      - name: Show release metadata
        run: echo "release_type -> ${{ needs.prepare_metadata.outputs.release_type }}"

  deploy_devnet:
    name: Deploy Devnet
    needs:
      - push
      - prepare_metadata
    runs-on: ubuntu-latest
    environment:
      name: devnet
      url: https://dev.sixsigmasports.app

    concurrency:
      group: devnet

    steps:
      - name: publish-images
        run: echo "Publishing images..."
      - name: Deploy to devnet
        run: echo "Deploying to devnet"

  deploy_testnet:
    name: Deploy Testnet
    needs:
      - deploy_devnet
      - prepare_metadata
    if: needs.prepare_metadata.outputs.release_type == 'release'
    runs-on: ubuntu-latest
    environment:
      name: testnet
      url: https://testnet.sixsigmasports.app

    concurrency:
      group: testnet

    steps:
      - name: Deploy to testnet
        run: echo "Deploying to testnet"

  deploy_mainnet:
    name: Deploy Mainnet
    needs:
      - deploy_testnet
      - prepare_metadata
    if: needs.prepare_metadata.outputs.release_type == 'release'
    runs-on: ubuntu-latest
    environment:
      name: mainnet
      url: https://sixsigmasports.app

    concurrency:
      group: mainnet

    steps:
      - name: Deploy to mainnet
        run: echo "Deploying to mainnet"
