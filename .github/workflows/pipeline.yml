name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - versions.json
      - .github/workflows/pipeline.yml
  workflow_dispatch:

jobs:
  determine_release_type:
    name: Determine release metadata
    runs-on: ubuntu-latest
    outputs:
      release_type: ${{ steps.extract.outputs.release_type }}
      components: ${{ steps.extract.outputs.components }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract release type
        id: extract
        run: |
          release_type=$(jq -r '.release_type // "release"' versions.json)
          components=$(jq -c '.components | to_entries | map({component: .key} + .value) // []' versions.json)
          echo "release_type=$release_type" >> "$GITHUB_OUTPUT"
          echo "components=$components" >> "$GITHUB_OUTPUT"
          echo "Release type detected: $release_type"

  push:
    name: Build and publish images
    needs: determine_release_type
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component: ${{ fromJson(needs.determine_release_type.outputs.components) }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - name: Dispatch component workflow
        env:
          OWNER: ${{ github.repository_owner }}
          COMPONENT_REPO: ${{ matrix.component.repo }}
          WORKFLOW_PATH: ${{ matrix.component.workflow }}
          COMPONENT_REF: ${{ matrix.component.ref }}
          COMPONENT_NAME: ${{ matrix.component.component }}
          TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          workflow_file=$(basename "$WORKFLOW_PATH")
          dispatch_url="https://api.github.com/repos/${OWNER}/${COMPONENT_REPO}/actions/workflows/${workflow_file}/dispatches"
          echo "Dispatching ${OWNER}/${COMPONENT_REPO}@${COMPONENT_REF} workflow ${workflow_file} (component ${COMPONENT_NAME})"
          curl -sSf -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${dispatch_url}" \
            -d "$(jq -n --arg ref "${COMPONENT_REF}" '{ref: $ref}')"
      - name: Show release metadata
        run: echo "release_type -> ${{ needs.determine_release_type.outputs.release_type }}"

  deploy_devnet:
    name: Deploy Devnet
    needs:
      - push
      - determine_release_type
    runs-on: ubuntu-latest
    environment:
      name: devnet
      url: https://dev.sixsigmasports.app

    concurrency:
      group: devnet

    steps:
      - name: publish-images
        run: echo "Publishing images..."
      - name: Deploy to devnet
        run: echo "Deploying to devnet"

  deploy_testnet:
    name: Deploy Testnet
    needs:
      - deploy_devnet
      - determine_release_type
    if: needs.determine_release_type.outputs.release_type == 'release'
    runs-on: ubuntu-latest
    environment:
      name: testnet
      url: https://testnet.sixsigmasports.app

    concurrency:
      group: testnet

    steps:
      - name: Deploy to testnet
        run: echo "Deploying to testnet"

  deploy_mainnet:
    name: Deploy Mainnet
    needs:
      - deploy_testnet
      - determine_release_type
    if: needs.determine_release_type.outputs.release_type == 'release'
    runs-on: ubuntu-latest
    environment:
      name: mainnet
      url: https://sixsigmasports.app

    concurrency:
      group: mainnet

    steps:
      - name: Deploy to mainnet
        run: echo "Deploying to mainnet"
