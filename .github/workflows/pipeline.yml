name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - versions.json
      - .github/workflows/pipeline.yml
      - scripts/**
  workflow_dispatch:
    inputs:
      release_type:
        description: "Override release type for this run (blank = keep file)"
        required: false
        default: pre-release
        type: choice
        options:
          - pre-release
          - release
      deploy_type:
        description: "Override deploy type for this run (blank = keep file)"
        required: false
        default: simple
        type: choice
        options:
          - simple
          - with-database-migration
          - with-chain-upgrade
          - with-database-migration-and-chain-upgrade
      image_publicmq_rust_ref:
        description: "publicmq-rust ref"
        required: false
        default: ""

jobs:
  prepare_metadata:
    name: Prepare release metadata
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_type: ${{ steps.extract.outputs.release_type }}
      images: ${{ steps.extract.outputs.images }}
    steps:
      - uses: actions/checkout@v4

      - name: Apply manual inputs
        if: github.event_name == 'workflow_dispatch'
        env:
          RELEASE_TYPE_INPUT: ${{ github.event.inputs.release_type }}
          DEPLOY_TYPE_INPUT: ${{ github.event.inputs.deploy_type }}
          INPUTS_JSON: ${{ toJson(github.event.inputs) }}
        run: |
          DEPLOY_TYPE_INPUT="${DEPLOY_TYPE_INPUT}" scripts/apply_manual_inputs.sh versions.json

      - name: Generate GitHub App token
        id: prepare-app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Resolve image refs
        env:
          OWNER: ${{ github.repository_owner }}
          TOKEN: ${{ steps.prepare-app-token.outputs.token }}
        run: scripts/resolve_image_refs.sh versions.json

      - name: Persist metadata updates
        run: scripts/persist_metadata.sh versions.json

      - name: Extract release type
        id: extract
        run: scripts/extract_release_metadata.sh versions.json "$GITHUB_OUTPUT"

  push:
    name: Build and publish images
    needs: prepare_metadata
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.prepare_metadata.outputs.images) }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Extract image metadata
        id: image_meta
        env:
          IMAGES_JSON: ${{ toJson(matrix.image) }}
        run: |
          echo "repo=${{ matrix.image.repo }}" >> "$GITHUB_OUTPUT"
          echo "workflow=${{ matrix.image.workflow }}" >> "$GITHUB_OUTPUT"
          echo "ref=${{ matrix.image.ref }}" >> "$GITHUB_OUTPUT"
          echo "image=${{ matrix.image.image }}" >> "$GITHUB_OUTPUT"
          echo "resolved_sha=${{ matrix.image.resolved_sha }}" >> "$GITHUB_OUTPUT"
      
      - name: Check if image exists
        id: image_exists
        env:
          OWNER: ${{ github.repository_owner }}
          TOKEN: ${{ steps.app-token.outputs.token }}
        run: scripts/check_image_exists.sh ${{ steps.image_meta.outputs.image }} ${{ steps.image_meta.outputs.resolved_sha }} "$GITHUB_OUTPUT"
      
      - name: Run image workflow
        if: steps.image_exists.outputs.image_exists != 'true'
        env:
          OWNER: ${{ github.repository_owner }}
          TOKEN: ${{ steps.app-token.outputs.token }}
        run: scripts/run_workflow_with_wait.sh ${{ steps.image_meta.outputs.repo }} ${{ steps.image_meta.outputs.workflow }} ${{ steps.image_meta.outputs.ref }}
      
      - name: Skip image workflow (image exists)
        if: steps.image_exists.outputs.image_exists == 'true'
        run: echo "Skipping workflow for ${{ steps.image_meta.outputs.image }}; image already exists."
      
      - name: Show release metadata
        run: echo "release_type -> ${{ needs.prepare_metadata.outputs.release_type }}"

  deploy_devnet:
    name: Deploy Devnet
    needs:
      - push
      - prepare_metadata
    runs-on: ubuntu-latest
    environment:
      name: devnet
      url: https://dev.sixsigmasports.app

    concurrency:
      group: devnet

    steps:
      - uses: actions/checkout@v4
      - name: Determine Devnet deployment plan
        id: devnet_plan
        run: scripts/plan_deployment.sh devnet "$GITHUB_OUTPUT"
      - name: Run Devnet deployment stages
        env:
          STAGES: ${{ steps.devnet_plan.outputs.stages }}
          SERVICE: ${{ steps.devnet_plan.outputs.service }}
        run: scripts/run_deploy_stages.sh devnet "$SERVICE" "$STAGES"

  deploy_testnet:
    name: Deploy Testnet
    needs:
      - deploy_devnet
      - prepare_metadata
    if: needs.prepare_metadata.outputs.release_type == 'release'
    runs-on: ubuntu-latest
    environment:
      name: testnet
      url: https://testnet.sixsigmasports.app

    concurrency:
      group: testnet

    steps:
      - name: Deploy to testnet
        run: echo "Deploying to testnet"

  deploy_mainnet:
    name: Deploy Mainnet
    needs:
      - deploy_testnet
      - prepare_metadata
    if: needs.prepare_metadata.outputs.release_type == 'release'
    runs-on: ubuntu-latest
    environment:
      name: mainnet
      url: https://sixsigmasports.app

    concurrency:
      group: mainnet

    steps:
      - name: Deploy to mainnet
        run: echo "Deploying to mainnet"
